<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Soul Trait Evolution (Live)</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    :root {
      --bg: #f6f8fa;
      --fg: #222;
      --panel: #fff;
      --panel-alt: #e9eef3;
      --accent: #4a90e2;
      --accent2: #b2c7e1;
      --table-header: #e9eef3;
      --table-row: #f6f8fa;
      --dominant: #e3f2fd;
      --msg-ai1: #e3f2fd;
      --msg-ai2: #fce4ec;
      --msg-meta: #7b8a99;
    }
    body.soft-blue {
      --bg: #eaf3fb;
      --fg: #223344;
      --panel: #f7fbff;
      --panel-alt: #dbeafe;
      --accent: #4a90e2;
      --accent2: #b2c7e1;
      --table-header: #dbeafe;
      --table-row: #eaf3fb;
      --dominant: #b3e5fc;
      --msg-ai1: #b3e5fc;
      --msg-ai2: #e1bee7;
      --msg-meta: #607d8b;
    }
    body.solarized {
      --bg: #fdf6e3;
      --fg: #657b83;
      --panel: #f5eecb;
      --panel-alt: #eee8d5;
      --accent: #268bd2;
      --accent2: #b58900;
      --table-header: #eee8d5;
      --table-row: #fdf6e3;
      --dominant: #b58900;
      --msg-ai1: #eee8d5;
      --msg-ai2: #f5eecb;
      --msg-meta: #657b83;
    }
    body.pastel {
      --bg: #f8f7fa;
      --fg: #4b3f72;
      --panel: #f3e8ff;
      --panel-alt: #e0c3fc;
      --accent: #a3cef1;
      --accent2: #f9c6c9;
      --table-header: #e0c3fc;
      --table-row: #f8f7fa;
      --dominant: #f9c6c9;
      --msg-ai1: #e0c3fc;
      --msg-ai2: #f9c6c9;
      --msg-meta: #4b3f72;
    }
    body {
      background: var(--bg);
      color: var(--fg);
      font-family: sans-serif;
      transition: background 0.3s, color 0.3s;
    }
    .tabs { display: flex; margin-bottom: 20px; }
    .tab {
      padding: 12px 28px;
      background: var(--panel-alt);
      color: var(--fg);
      border-radius: 8px 8px 0 0;
      margin-right: 6px;
      cursor: pointer;
      font-weight: 500;
      border: none;
      outline: none;
      transition: background 0.2s, color 0.2s;
    }
    .tab.active {
      background: var(--panel);
      color: var(--accent);
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    #barplot { width:900px; height:350px; margin-bottom: 30px; }
    #timeline { width:900px; height:300px; margin-bottom: 30px; }
    #trait-table, #discovered-table {
      background: var(--panel);
      color: var(--fg);
      font-family: 'Courier New', Courier, monospace;
      border-radius: 8px;
      max-width: 900px;
      margin: 0 auto 30px auto;
      border-collapse: collapse;
      width: 900px;
      box-shadow: 0 2px 8px #0002;
    }
    #trait-table th, #trait-table td, #discovered-table th, #discovered-table td {
      border: 1px solid var(--panel-alt);
      padding: 8px 12px;
      text-align: left;
    }
    #trait-table th, #discovered-table th { background: var(--table-header); color: var(--accent); }
    #trait-table tr.dominant { background: var(--dominant); }
    #terminal {
      background: var(--panel);
      color: var(--accent);
      font-family: 'Courier New', Courier, monospace;
      padding: 20px;
      border-radius: 8px;
      min-height: 120px;
      max-width: 900px;
      margin: 0 auto;
      white-space: pre-line;
      word-break: break-word;
      overflow-wrap: break-word;
      box-shadow: 0 2px 8px #0002;
    }
    #conversation {
      background: var(--panel);
      color: var(--fg);
      font-family: 'Courier New', Courier, monospace;
      border-radius: 8px;
      max-width: 900px;
      margin: 0 auto 30px auto;
      padding: 20px;
      min-height: 200px;
      box-shadow: 0 2px 8px #0002;
    }
    .msg {
      margin-bottom: 18px;
      padding: 10px 16px;
      border-radius: 6px;
      background: var(--panel-alt);
      color: var(--fg);
      max-width: 80%;
      box-shadow: 0 1px 4px #0001;
    }
    .msg.ai1 { background: var(--msg-ai1); color: var(--accent); align-self: flex-start; }
    .msg.ai2 { background: var(--msg-ai2); color: var(--fg); align-self: flex-end; }
    .msg .meta { font-size: 0.9em; color: var(--msg-meta); margin-bottom: 4px; }
    .msg .text { white-space: pre-line; }
    .theme-select {
      margin: 20px 0 0 0;
      padding: 10px 16px;
      font-size: 1em;
      border-radius: 6px;
      border: 1px solid var(--panel-alt);
      background: var(--panel);
      color: var(--fg);
      outline: none;
    }
  </style>
</head>
<body>
  <div id="api-key-setup" style="max-width:900px;margin:40px auto 30px auto;padding:30px 30px 20px 30px;background:var(--panel);border-radius:10px;box-shadow:0 2px 8px #0002;">
    <h2>Enter API Keys to Begin</h2>
    <label for="hf-key"><b>Hugging Face API Key:</b></label><br>
    <input id="hf-key" type="password" style="width:100%;margin-bottom:12px;padding:10px;border-radius:6px;border:1px solid var(--panel-alt);background:var(--panel);color:var(--fg);"><br>
    <label for="gemini-key"><b>Gemini API Key:</b></label><br>
    <input id="gemini-key" type="password" style="width:100%;margin-bottom:12px;padding:10px;border-radius:6px;border:1px solid var(--panel-alt);background:var(--panel);color:var(--fg);"><br>
    <button id="set-keys-btn" style="padding:10px 24px;border-radius:6px;background:var(--accent);color:#fff;border:none;cursor:pointer;font-size:1em;">Set API Keys</button>
    <span id="api-key-status" style="margin-left:20px;"></span>
  </div>
  <div id="main-dashboard" style="display:none;">
    <h1>Soul Trait Evolution (Live)</h1>
    <div class="tabs">
      <button class="tab active" onclick="showTab('traits')">Traits Table</button>
      <button class="tab" onclick="showTab('timeline')">Timeline</button>
      <button class="tab" onclick="showTab('conversation')">Conversation</button>
      <button class="tab" onclick="showTab('customization')">Customization</button>
    </div>
    <div id="traits" class="tab-content active">
      <div id="barplot"></div>
      <table id="trait-table"></table>
      <table id="discovered-table"></table>
      <div id="terminal">Waiting for data...</div>
    </div>
    <div id="timeline" class="tab-content">
      <div id="timeline"></div>
    </div>
    <div id="conversation" class="tab-content">
      <div id="conversation"></div>
    </div>
    <div id="customization" class="tab-content">
      <label for="theme-select"><b>Choose a theme:</b></label>
      <select id="theme-select" class="theme-select">
        <option value="">Light (Default)</option>
        <option value="soft-blue">Soft Blue</option>
        <option value="solarized">Solarized</option>
        <option value="pastel">Pastel</option>
      </select>
      <hr style="margin: 30px 0;">
      <label for="prompt-box"><b>Custom Reflection Prompt:</b></label><br>
      <textarea id="prompt-box" rows="4" style="width: 100%; max-width: 900px; border-radius: 6px; border: 1px solid var(--panel-alt); background: var(--panel); color: var(--fg); padding: 10px; margin-top: 8px;"></textarea><br>
      <button id="set-prompt-btn" style="margin-top: 10px; padding: 10px 20px; border-radius: 6px; background: var(--accent); color: #fff; border: none; cursor: pointer; font-size: 1em;">Set Prompt</button>
      <span id="prompt-status" style="margin-left: 20px; color: var(--accent);"></span>
    </div>
  </div>
  <script>
    // API Key Setup Logic
    document.getElementById('set-keys-btn').onclick = async function() {
      const hf = document.getElementById('hf-key').value.trim();
      const gem = document.getElementById('gemini-key').value.trim();
      const status = document.getElementById('api-key-status');
      status.textContent = 'Validating...';
      status.style.color = 'var(--accent)';
      try {
        const resp = await fetch('/set_api_keys', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ hf_api_key: hf, gemini_api_key: gem })
        });
        const data = await resp.json();
        if (resp.ok && data.status === 'ok') {
          status.textContent = 'API keys accepted!';
          status.style.color = 'green';
          document.getElementById('api-key-setup').style.display = 'none';
          document.getElementById('main-dashboard').style.display = '';
          // Now connect WebSocket and start dashboard
          window.ws = new WebSocket("wss://" + window.location.host + "/ws");
          ws.onmessage = ws_onmessage_handler;
        } else {
          let msg = 'Error: ';
          if (data.errors) {
            msg += Object.values(data.errors).join(' ');
          } else {
            msg += 'Unknown error.';
          }
          status.textContent = msg;
          status.style.color = 'red';
        }
      } catch (e) {
        status.textContent = 'Failed to validate API keys.';
        status.style.color = 'red';
      }
    };
    // Only connect WebSocket after API keys are set
    let ws;
    function ws_onmessage_handler(event) {
      let data = JSON.parse(event.data);
      let traits = data.traits;
      traitNames = data.trait_names;
      history = data.history;
      traitFirstSeen = data.trait_first_seen;
      // Dominance calculation
      let sum = Object.values(traits).reduce((a, b) => a + b, 0) || 1;
      let dominance = {};
      for (let k of Object.keys(traits)) dominance[k] = traits[k] / sum * 100;
      let dominantTrait = Object.keys(dominance).reduce((a, b) => dominance[a] > dominance[b] ? a : b);
      // Update all visualizations
      updateBarPlot(traits, dominance);
      updateTraitTable(traits, dominance, dominantTrait);
      updateDiscoveredTable(traitFirstSeen, traits, data.step);
      updateTimeline(history, traitNames);
      document.getElementById('terminal').textContent = interpret(traits, dominance, dominantTrait);
      updateConversation(data.conversation_history);
    }
    let history = [];
    let traitNames = [];
    let traitFirstSeen = {};

    function showTab(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      document.querySelectorAll('.tab').forEach(t => {
        if (t.textContent.replace(/\s+/g, '').toLowerCase().includes(tab)) {
          t.classList.add('active');
        }
      });
      document.getElementById(tab).classList.add('active');
    }

    document.getElementById('theme-select').addEventListener('change', function() {
      document.body.className = this.value;
    });

    function interpret(traits, dominance, dominantTrait) {
      let lines = Object.entries(traits).map(
        ([k, v]) => `${k.padEnd(16)} ${v.toFixed(2)} (${dominance[k].toFixed(1)}%)`
      );
      let summary = `\nMost dominant trait: ${dominantTrait} (${dominance[dominantTrait].toFixed(1)}%)\n`;
      summary += dominance[dominantTrait] > 60
        ? "This trait is defining the soul right now."
        : "The soul is balancing multiple influences.";
      return lines.join('\n') + "\n\n" + summary;
    }

    function updateBarPlot(traits, dominance) {
      let names = Object.keys(traits);
      let values = names.map(k => traits[k]);
      let doms = names.map(k => dominance[k]);
      let colors = names.map(k => doms[k] === Math.max(...doms) ? 'var(--accent)' : 'var(--accent2)');
      let data = [{
        x: names,
        y: values,
        type: 'bar',
        marker: { color: colors },
        text: doms.map(d => d.toFixed(1) + '%'),
        textposition: 'auto',
        hovertemplate: '%{x}: %{y:.2f} (%{text})<extra></extra>'
      }];
      let layout = {
        title: 'Current Soul Traits',
        yaxis: { range: [0, 1] },
        plot_bgcolor: 'var(--bg)',
        paper_bgcolor: 'var(--bg)',
        font: { color: 'var(--fg)' }
      };
      Plotly.react('barplot', data, layout);
    }

    function updateTraitTable(traits, dominance, dominantTrait) {
      let table = document.getElementById('trait-table');
      let rows = `<tr><th>Trait</th><th>Value</th><th>Dominance (%)</th></tr>`;
      for (let k of Object.keys(traits)) {
        let dom = dominance[k].toFixed(1);
        let rowClass = k === dominantTrait ? 'dominant' : '';
        rows += `<tr class="${rowClass}"><td>${k}</td><td>${traits[k].toFixed(2)}</td><td>${dom}</td></tr>`;
      }
      table.innerHTML = rows;
    }

    function updateDiscoveredTable(traitFirstSeen, traits, step) {
      let table = document.getElementById('discovered-table');
      let rows = `<tr><th>Trait</th><th>First Seen (Step)</th><th>Current Value</th></tr>`;
      let allTraits = Object.keys(traitFirstSeen).sort((a, b) => traitFirstSeen[a] - traitFirstSeen[b]);
      for (let k of allTraits) {
        let val = traits[k] !== undefined ? traits[k].toFixed(2) : 'â€”';
        rows += `<tr><td>${k}</td><td>${traitFirstSeen[k]}</td><td>${val}</td></tr>`;
      }
      table.innerHTML = rows;
    }

    function updateTimeline(history, traitNames) {
      let z = history.map(snap => traitNames.map(t => snap[t] !== undefined ? snap[t] : null));
      let data = [{
        z: z,
        x: traitNames,
        y: Array.from({length: history.length}, (_, i) => i),
        type: 'heatmap',
        colorscale: 'YlGnBu',
        colorbar: { title: 'Value', tickvals: [0, 0.5, 1] },
        hoverongaps: false
      }];
      let layout = {
        title: 'Trait Timeline (Heatmap)',
        xaxis: { title: 'Trait' },
        yaxis: { title: 'Step', autorange: 'reversed' },
        plot_bgcolor: 'var(--bg)',
        paper_bgcolor: 'var(--bg)',
        font: { color: 'var(--fg)' },
        margin: { t: 40 }
      };
      Plotly.react('timeline', data, layout);
    }

    function updateConversation(conversation) {
      let div = document.getElementById('conversation');
      div.innerHTML = conversation.map(msg => `
        <div class="msg ${msg.speaker.toLowerCase()}">
          <div class="meta">${msg.speaker} &middot; ${new Date(msg.timestamp).toLocaleString()}</div>
          <div class="text">${msg.text.replace(/\n/g, '<br>')}</div>
        </div>
      `).join('');
    }

    document.getElementById('set-prompt-btn').onclick = async function() {
      const prompt = document.getElementById('prompt-box').value;
      const status = document.getElementById('prompt-status');
      status.textContent = 'Setting...';
      try {
        const resp = await fetch('/set_prompt', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ prompt })
        });
        if (resp.ok) {
          status.textContent = 'Prompt set!';
        } else {
          status.textContent = 'Failed to set prompt.';
        }
      } catch {
        status.textContent = 'Failed to set prompt.';
      }
    };
  </script>
</body>
</html> 